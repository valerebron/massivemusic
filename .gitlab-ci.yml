cache:
  paths:
  - node_modules/
stages:
  - build-vue-app
  - setup-bdd
  - deploy

build-vue-app:
  stage: build-vue-app
  artifacts:
    paths:
      - node_modules/
      - dist/
      - api/
      - config.js
      - server.js
      - docker-compose.yml
      - Dockerfile
  image: node:10.15-alpine
  before_script:
   - apk update && apk add yarn -y
   - rm config.json && mv configDist.json config.json
  script:
   - yarn && yarn build

setup-bdd:
  stage: setup-bdd
  script:
    - export MONGO_PASS=$MONGO_PASS MONGO_USER=$MONGO_USER
    - mkdir mongoconf
    - cd mongoconf
    - pwd
    - echo -e "#\!/usr/bin/env bash\necho 'Creating application user and db'\nmongo app_db --host localhost --port 27017 -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval \"db.createUser({user: '$MONGO_USER', pwd: '$MONGO_PASS', roles:[{role:'dbOwner', db: 'massivemusic'}]});\"" >> mongo-createuser-entrypoint.sh

deploy:
  stage: deploy
  tags: [shell]
  dependencies:
    - build-vue-app
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - cd /var/www/html/massivemusic2 && git pull
    - rm config.json && mv configDist.json config.json
  script:
    - mkdir -p /data/db/massivemusic2
    - docker build -t $CI_REGISTRY_IMAGE .
    - docker push $CI_REGISTRY_IMAGE
    - docker-compose up -d
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: https://massivemusic.fr
